<!DOCTYPE HTML>
<html>
<head>
<title>Walking Desu</title>
<style>
	body {
		margin: 0;
		padding: 0;
		background-color: #000000;
	}
</style>
<script src="//cdnjs.cloudflare.com/ajax/libs/pixi.js/1.5.2/pixi.js"></script>
</head>
<body>
<script>
	"use strict";
	var stage = new PIXI.Stage(0x66FF99);
	var renderer = new PIXI.autoDetectRenderer(800, 600);
	document.body.appendChild(renderer.view);


	var Desunation = new PIXI.DisplayObjectContainer();
	stage.addChild(Desunation);

	// z-index
	function comparationY(a, b) {
		return a.position.y - b.position.y;
	}

	setInterval(function() {
		Desunation.children.sort(comparationY)
	}, 60);

	var Desu = function(states) {
		PIXI.DisplayObjectContainer.call(this);

		this._states = states;
		for (var i in states) {
			var s = states[i];
			this.addChild(s);
		}
		this._rot = 0;
	};

	Desu.prototype = Object.create( PIXI.DisplayObjectContainer.prototype );
	Desu.prototype.constructor = Desu;

	Object.defineProperty(Desu.prototype, 'rot', {
		get: function() { return this._rot; },
		set: function(value) {
			var dir = "down";
			if(value < 0) {
				value += -value - (-value) % Math.PI
			}
			if(value > Math.PI) {
				value -= value - value % Math.PI
			}
			var n = Math.PI / 8.0;
			if(value > n) {
				dir = "down-left";
			}
			if(value > n * 2) {
				dir = "up-left";
			}
			if(value > n * 3) {
				dir = "up";
			}
			if(value > n * 5) {
				dir = "up-right";
			}
			if(value > n * 6) {
				dir = "down-right";
			}
			if(value > n * 7) {
				dir = "down";
			}
			this._rot = value;
			this.anim(null, dir);
			/*for(var i in this._states) {
				var s = this._states[i];
				s.anchor.x = value.x;
				s.anchor.y = value.y;
			}*/
		}
	});

	Object.defineProperty(Desu.prototype, 'anchor', {
		set: function(value) {
			for(var i in this._states) {
				var s = this._states[i];
				s.anchor.x = value.x;
				s.anchor.y = value.y;
			}
		}
	});

	Desu.prototype.anim = function(anim, dir) {
		if(!anim) anim = this._anim;
		if(!dir) dir = this._dir;
		this._dir = dir;
		this._anim = anim;
		for(var i in this._states) {
			var s = this._states[i];
			s.visible = i == anim + " " + dir
		}
	};


		function make_desu(states) {
			var desu = new Desu(states);

			desu.position.x = Math.random() * 800;
			desu.position.y = Math.random() * 600+50;
			//desu.position.x = 200;
			//desu.position.y = 250;

			desu.anchor = {x: 0.5, y: 0.875};
			desu.scale.x = 0.5;
			desu.scale.y = 0.5;

			desu.anim("walk", "down");
			//desu.rot = 0.5;
			desu.rot = Math.random() * Math.PI * 2;

			Desunation.addChild(desu);
		}

	// load desu
	var loader = new PIXI.AssetLoader(["desu.json"]);
	loader.addEventListener('onComplete', function() {
		var desu_frames = function(dir) {
			var frames = [];
			for(var i=0, l=dir.length; i<l; i++) {
				frames.push(PIXI.Texture.fromFrame("desu/" + dir[i]));
			}
			var movie = new PIXI.MovieClip(frames);
			movie.animationSpeed = 0.2;
			movie.loop = true;
			movie.play();
			return movie;
		};


		for(var i=0; i<= 600; i++) {
			var states = {
				"idle up"         : desu_frames(["idle-up"]),
				"idle up-left"    : desu_frames(["idle-up-left"]),
				"idle up-right"   : desu_frames(["idle-up-right"]),
				"idle down"       : desu_frames(["idle-down"]),
				"idle down-left"  : desu_frames(["idle-down-left"]),
				"idle down-right" : desu_frames(["idle-down-right"]),

				"walk up"         : desu_frames(["walk-up",         "idle-up"]),
				"walk up-left"    : desu_frames(["walk-up-left",    "idle-up-left"]),
				"walk up-right"   : desu_frames(["walk-up-right",   "idle-up-right"]),
				"walk down"       : desu_frames(["walk-down",       "idle-down"]),
				"walk down-left"  : desu_frames(["walk-down-left",  "idle-down-left"]),
				"walk down-right" : desu_frames(["walk-down-right", "idle-down-right"]),

				"blink down"      : desu_frames(["blink-down-1", "blink-down-2", "idle-down"]),
			};
			make_desu(states);
		}

	});
	loader.load();

	// start
	requestAnimFrame(animate);
	function animate() {
		requestAnimFrame(animate);
		//if(desu) desu.rot += 0.2;
		renderer.render(stage);
	};
</script>
</body>
</html>
