<!DOCTYPE HTML>
<html>
<head>
<title>Walking Desu</title>
<style>
	body {
		margin: 0;
		padding: 0;
		background-color: #000000;
	}
</style>
<script src="//cdnjs.cloudflare.com/ajax/libs/pixi.js/1.5.2/pixi.js"></script>
<script src="spp.min.js"></script>
</head>
<body>
<script>
	//"use strict";

var mouse;

var stageHeight = 800;
var stageWidth = 600;

	var stage = new PIXI.Stage(0x66FF99);
	var renderer = new PIXI.autoDetectRenderer(800, 600);
	document.body.appendChild(renderer.view);
	
	renderer.view.addEventListener('mousemove', mousemove, false);







/*

var canvas;
var context;
var particleSystem;
var boundary;
var mouse;
var texture;
var stats;
var repulsionForce;
var zone;


$(document).ready(function() {
	init();
	$(window).resize(resizeCanvas);
});

function init() {
	canvas = $("canvas").get(0);
	canvas.addEventListener('mousemove', mousemove, false);
	context = canvas.getContext("2d");

	particleSystem = new SPP.ParticleSystem();
	mouse=new SPP.Vector2D();
	repulsionForce=particleSystem.createForce(SPP.Repulsion);
	repulsionForce.init(mouse, 2,200);
	zone=new SPP.Zone();
	zone.boundary=new SPP.Rectangle(0,0,canvas.width,canvas.height);

	texture = new Image();
	texture.src = "images/arrow.png";
	$(texture).load(function() {
		//initStatsBar();
		resizeCanvas();
		animate();
		particleSystem.start();
		initParticles();
	});
}

function initParticles() {
	for ( var i = 0; i < 1000; i++) {
		var p = particleSystem.createParticle(SPP.SpriteImage);
		p.init(canvas.width*0.5, canvas.height*0.5,Infinity,texture,context);
		p.zone=zone;
		var brownianForce =particleSystem.createForce(SPP.Brownian);
		brownianForce.init(0.5, Math.random()*2+1);
		p.addForce("brownianForce",brownianForce);
		p.addForce("repulsionForce", repulsionForce);
		p.onUpdate=arrowUpdate;
	}
};
*/

function arrowUpdate() {
	this.rotation=SPP.MathUtils.toRadian(this.velocity.getAngle());
};


function mousemove(e) {
	// Get the mouse position relative to the canvas element.
	if (e.layerX || e.layerX == 0) { // Firefox
		mouse.x = e.layerX;
		mouse.y = e.layerY;
	} else if (e.offsetX || e.offsetX == 0) { // Opera
		mouse.x = e.offsetX;
		mouse.y = e.offsetY;
	};
};

















	var Desunation = new PIXI.DisplayObjectContainer();
	stage.addChild(Desunation);

	// z-index
	function comparationY(a, b) {
		return a.position.y - b.position.y;
	}

	setInterval(function() {
		Desunation.children.sort(comparationY)
	}, 60);

	var Desu = function(states) {
		PIXI.DisplayObjectContainer.call(this);

		this._states = states;
		for (var i in states) {
			var s = states[i];
			this.addChild(s);
		}
		this._rot = 0;
	};

	Desu.prototype = Object.create( PIXI.DisplayObjectContainer.prototype );
	Desu.prototype.constructor = Desu;

	Object.defineProperty(Desu.prototype, 'rot', {
		get: function() { return this._rot; },
		set: function(value) {
			var dir = "down";
			var anim = "blink";
			value = - value;

			/*if(value > Math.PI) {
				value -= value - value % Math.PI
			}*anim = "walk";/

			/*if(value < 0) {
				value += -value - (-value) % Math.PI
			}*/

			//if (value >= -3.0*Math.PI/4.0) {dir = "up-left";}
			//if (value >= -Math.PI/4.0) {dir = "down-left";}

			if (value >= 0) {anim = "walk";dir = "up-right";}
			if (value >= Math.PI/4.0) {anim = "walk";dir = "up";}
			if (value >= 3.0*Math.PI/4.0) {anim = "walk";dir = "up-left";}
			if (value >= Math.PI) {anim = "walk";dir = "down-left";}
			if (value >= 5.0*Math.PI/4.0) {anim = "walk";dir = "down";}
			if (value >= 7.0*Math.PI/4.0) {anim = "walk";dir = "down-left";}
			if (value >= 7.0*Math.PI/4.0) {anim = "walk";dir = "down-left";}

			//if (value >= 2*Math.PI) {dir = "down";anim = "blink";}
			//value += Math.PI/2;
			//value = -value
			/*if(value < 0) {
				value += -value - (-value) % Math.PI
			}
			if(value > Math.PI) {
				value -= value - value % Math.PI
			}*/
			/*var n = Math.PI / 8.0;
			var pi = Math.PI;
			if(value > pi/4) {
				dir = "up-right";
			}
			if(value > n * 2) {
				dir = "up";
			}
			if(value > 3*n * 4) {
				dir = "up-left";
			}
			if(value > pi) {
				dir = "down-left";
			}
			if(value > 5*pi*3) {
				dir = "down";
			}
			/*if(value > n * 7) {
				dir = "down";
			}*/
			this._rot = value;
			this.anim(anim, dir);
			/*for(var i in this._states) {
				var s = this._states[i];
				s.anchor.x = value.x;
				s.anchor.y = value.y;
			}*/
		}
	});

	Object.defineProperty(Desu.prototype, 'anchor', {
		set: function(value) {
			for(var i in this._states) {
				var s = this._states[i];
				s.anchor.x = value.x;
				s.anchor.y = value.y;
			}
		}
	});

	Desu.prototype.anim = function(anim, dir) {
		if(!anim) anim = this._anim;
		if(!dir) dir = this._dir;
		this._dir = dir;
		this._anim = anim;
		for(var i in this._states) {
			var s = this._states[i];
			s.visible = i == anim + " " + dir
		}
	};






function Leaf () {
	SPP.Particle.call(this);
};
SPP.inherit(Leaf, SPP.Particle);
Leaf.prototype.update = function () {
	if(!this.sprite)return;
	this.life = Infinity;

	this.sprite.position.x = this.position.x;
	this.sprite.position.y = this.position.y;
	//this.sprite.rotation+=this.rotationStep;
	this.sprite.rot += this.rotationStep;
this.sprite.rot = SPP.MathUtils.toRadian(this.velocity.getAngle());
	//this.sprite.scale.x+=this.scaleStep;
	//this.sprite.scale.y+=this.scaleStep;

	if (this.position.y > (stageHeight + 100)||this.position.x > (stageWidth + 100)) {
		//this.life = 0;
		//this.sprite.parent.removeChild(this.sprite);

		//SpritePool.getInstance().recycle(this.sprite);
		//this.sprite = null;
		//dele
	}
};
Leaf.prototype.init = function (x, y, life, sprite) {
	SPP.Particle.prototype.init.apply(this, [x, y, life]);

	/*
		var p = particleSystem.createParticle(SPP.SpriteImage);
        p.init(canvas.width*0.5, canvas.height*0.5,Infinity,texture,context);
		*/
	
		/*this.zone=zone;
		var brownianForce =particleSystem.createForce(SPP.Brownian);
        brownianForce.init(0.5, Math.random()*2+1);
        this.addForce("brownianForce",brownianForce);
		this.addForce("repulsionForce", repulsionForce);
		this.onUpdate=arrowUpdate;
		*/

	
	this.sprite = sprite;
	//this.sprite.anchor.x = 0.5;
	//this.sprite.anchor.y = 0.5;
	//this.sprite.scale.x=this.sprite.scale.y=0.5+Math.random()*0.5;

	/*this.rotationStep=(1-Math.random()*2)*0.05;
	if(this.rotationStep>0)this.rotationStep+=0.03;
	else
		this.rotationStep-=0.05;
	this.scaleStep=-(Math.random()*0.003);
	*/
};

function LeafEmitter(container) {
	var _container = container;
	var _lastTime = Date.now();

	function emit() {
		//var sprite = SpritePool.getInstance().get("leaf_" + SPP.MathUtils.random(4) + ".png");
		var sprite = make_desu(states())

		//var p = particleSystem.createParticle(SPP.SpriteImage);


		//sprite.position.y = -999;
		var p = particleSystem.createParticle(Leaf);
		p.init(-80, -80, Infinity, sprite);


		//p.init(renderer.view.width*0.5, renderer.view.height*0.5,Infinity,sprite);
		p.zone=zone;
		var brownianForce =particleSystem.createForce(SPP.Brownian);
		brownianForce.init(0.5, Math.random()*1+1);
		p.addForce("brownianForce",brownianForce);
		p.addForce("repulsionForce", repulsionForce);
		p.onUpdate=arrowUpdate;


		/*
		particle.velocity.reset(0, 1+Math.random() * 2);
		particle.damp.reset(0, 0);

		particle.addForce("windForce", windForce);
		var brownian = particleSystem.createForce(SPP.Brownian);
		brownian.init(0.15, Math.random()+0.5);
		brownian.target=particle;
		particle.addForce("brownianForce", brownian);
		*/
		_container.addChild(sprite);
	}
	this.emit = emit

	this.update = function () {
		//for(var i=0;i<10;i++) {
			//emit();
		//}
	}
};

function desu_frames(dir) {
	var frames = [];
	for(var i=0, l=dir.length; i<l; i++) {
		frames.push(PIXI.Texture.fromFrame("desu/" + dir[i]));
	}
	var movie = new PIXI.MovieClip(frames);
	movie.animationSpeed = 0.2;
	movie.loop = true;
	movie.play();
	return movie;
};


function states(){
	return {
		"idle up"         : desu_frames(["idle-up"]),
		"idle up-left"    : desu_frames(["idle-up-left"]),
		"idle up-right"   : desu_frames(["idle-up-right"]),
		"idle down"       : desu_frames(["idle-down"]),
		"idle down-left"  : desu_frames(["idle-down-left"]),
		"idle down-right" : desu_frames(["idle-down-right"]),

		"walk up"         : desu_frames(["walk-up",         "idle-up"]),
		"walk up-left"    : desu_frames(["walk-up-left",    "idle-up-left"]),
		"walk up-right"   : desu_frames(["walk-up-right",   "idle-up-right"]),
		"walk down"       : desu_frames(["walk-down",       "idle-down"]),
		"walk down-left"  : desu_frames(["walk-down-left",  "idle-down-left"]),
		"walk down-right" : desu_frames(["walk-down-right", "idle-down-right"]),

		"blink down"      : desu_frames(["blink-down-1", "blink-down-2", "idle-down"]),
	};
}



		function make_desu(states) {
			var desu = new Desu(states);

			//desu.position.x = Math.random() * 800;
			//desu.position.y = Math.random() * 600+50;
			desu.position.x = 200;
			desu.position.y = 250;

			desu.anchor = {x: 0.5, y: 0.875};
			desu.scale.x = 0.5;
			desu.scale.y = 0.5;

			desu.anim("walk", "down");
			//desu.rot = 0.5;
			desu.rot = Math.random() * Math.PI * 2;

			//Desunation.addChild(desu);
			return desu;
		}

	// load desu
	var loader = new PIXI.AssetLoader(["desu.json"]);
	loader.addEventListener('onComplete', function() {

	renderer.view.addEventListener('mousemove', mousemove, false);

	particleSystem = new SPP.ParticleSystem();

	particleSystem = new SPP.ParticleSystem();
	mouse=new SPP.Vector2D();
	repulsionForce=particleSystem.createForce(SPP.Repulsion);
	repulsionForce.init(mouse, 2,200);
	zone=new SPP.Zone();
	zone.boundary=new SPP.Rectangle(0,0,renderer.view.width,renderer.view.height);



    //leafEmitter=new LeafEmitter(stage);
    leafEmitter=new LeafEmitter(Desunation);
	desu_desu = make_desu(states());

	stage.addChild(desu_desu);

		/*for(var i=0; i<= 1; i++) {
		var f = function() {

			var desu = make_desu(states());
			setInterval(function(){
					desu.rot += Math.random()*Math.PI - Math.PI/2;
			}, Math.random()*300);
		};
		f();
		*/

    //leafEmitter=new LeafEmitter(stage);
		for(var i=0; i<= 100; i++) {
			leafEmitter.emit()
		}
    particleSystem.start();

	});
	loader.load();

	// start
	requestAnimFrame(animate);
	function animate() {
		requestAnimFrame(animate);
		//if(desu) desu.rot += 0.2;

    particleSystem.render();
    leafEmitter.update();
		renderer.render(stage);
	};
</script>
</body>
</html>
